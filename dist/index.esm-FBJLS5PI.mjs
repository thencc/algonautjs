import{k as a}from"./chunk-LM3IO2MR.mjs";a();var y=Object.defineProperty,w=Object.defineProperties,f=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,o=(t,e,s)=>e in t?y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,c=(t,e)=>{for(var s in e||(e={}))m.call(e,s)&&o(t,s,e[s]);if(l)for(var s of l(e))p.call(e,s)&&o(t,s,e[s]);return t},d=(t,e)=>w(t,f(e)),g="https://inkey.app",v=class{constructor(t){if(this.ready=!1,this.initing=!1,this.destroying=!1,this.__v_skip=!0,this.walEl=null,this.walElContainer=null,this.walWin=null,this.onMsgHandler=null,this.requests=new Map,!t)this.initSrc();else if(typeof t=="string")this.initSrc(t);else if(typeof t=="object")if(t.src)t.align?this.initSrc(t.src,t.align):this.initSrc(t.src);else throw new Error("bad inkey config, cannot init");else throw new Error("err constructing FrameBus");document.body.addEventListener("DOMNodeRemoved",e=>{this.destroying||e.target==this.walElContainer&&(console.log("iframe container removed from DOM"),this.destroy())},!1)}async initSrc(t=g,e="center"){if(console.log("initSrc",t),document.querySelector("iframe#inkey-wallet")){console.warn("dont mount frame to DOM again");return}this.destroy(),this.initing=!0;let r=document.createElement("div");r.setAttribute("id","inkey-wallet-container"),r.style.position="fixed",e=="left"&&r.classList.add("align-left"),e=="right"&&r.classList.add("align-right");let i=document.createElement("iframe");i.src=t,i.classList.add("inkey-wallet"),i.setAttribute("id","inkey-wallet"),i.setAttribute("name","walFrame"),i.setAttribute("title","Algorand Microwallet"),i.setAttribute("frameborder","0"),i.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-downloads"),i.setAttribute("allow","publickey-credentials-get; clipboard-write"),i.style.display="none",i.style.visibility="hidden",this.walEl=i,this.walElContainer=r,r.appendChild(i),document.body.appendChild(r);let n=i.contentWindow;if(!n){console.error("no walWin");return}this.walWin=n,i.addEventListener("load",()=>{console.log("iframe loaded"),setTimeout(()=>{i.style.display="initial"},100),this.ready=!0,this.initing=!1,this.onMsgHandler=this.onMessage.bind(this),window.addEventListener("message",this.onMsgHandler,!1);let h={type:"get-style-recs"};this.emit(h);let u={type:"init-comms",payload:{url:window.location.origin+window.location.pathname}};this.emit(u)})}showFrame(t){if(console.log("showFrame",t),this.walEl){this.walEl.classList.add("visible"),this.walEl.style.position="sticky",setTimeout(()=>{this.walEl&&(this.walEl.style.position="absolute")},100);let e={type:"set-visibility",payload:{visible:!0,route:t}};this.emit(e)}}hideFrame(){if(this.walEl){this.walEl.classList.remove("visible");let t={type:"set-visibility",payload:{visible:!1}};this.emit(t)}}setHeight(t,e="px"){this.walEl&&(this.walEl.style.height=`${t}${e}`)}destroy(){this.destroying=!0,this.walElContainer&&(this.walEl&&this.walElContainer.removeChild(this.walEl),document.body.removeChild(this.walElContainer),this.walElContainer=null),this.walEl&&(this.walEl=null),this.walWin&&(this.walWin=null),this.onMsgHandler&&(window.removeEventListener("message",this.onMsgHandler,!1),this.onMsgHandler=null),this.removeStyles(),this.ready=!1,this.initing=!1,this.destroying=!1}async isReady(){return new Promise(t=>{if(this.ready)t(!0);else if(this.initing){let e=setInterval(()=>{console.log("isReady intervaling"),this.ready&&(clearInterval(e),t(!0))},150)}else console.warn("do initSrc again"),t(!1)})}setOnDisconnect(t){this.onDisconnect=t}onDisconnect(){console.log("onDisconnect")}onMessage(t){let e=t.data;if(e.source&&e.source=="ncc-inkey-wallet"){if(console.log("inkey-client got msg:",e),e.type==="hide"&&this.hideFrame(),e.type==="disconnect"&&this.onDisconnect(),e.type==="set-height"){let s=e.payload.height;s&&this.setHeight(s)}if(e.type=="style-recs"){let s=e.payload.css;this.insertStyles(s)}if(e.type=="async-reply"&&e.async&&e.async==!0&&e.uuid){let s=this.requests.get(e.uuid);if(!s)throw Error("got an async msg back but could not match the uuid to resolve it");this.requests.delete(e.uuid);let r=s.resolve;r(e.payload)}}}emit(t){if(console.log("inkeyClient>emit",t),!this.ready)throw new Error("FrameBus not ready");let e=new Date().getTime().toString();if(t=d(c({},t),{source:"ncc-inkey-client",uuid:e}),this.walEl&&this.walWin)this.walWin.postMessage(t,this.walEl.src);else throw new Error("no wallEl or walWin");return t}emitAsync(t){return t=d(c({},t),{async:!0}),t=this.emit(t),new Promise(e=>{if(t.uuid==null)throw new Error("emit returned without data.uuid");this.requests.set(t.uuid,{req:t,resolve:e})})}insertStyles(t){let e=document.querySelector("style#inkey-wallet-styles");if(e)e.innerText=t;else{let s=document.createElement("style");s.setAttribute("id","inkey-wallet-styles"),s.innerText=t,document.head.appendChild(s)}this.walEl?setTimeout(()=>{this.walEl&&(this.walEl.style.visibility="initial")},100):console.warn("no walEl for style.visibility reset")}removeStyles(){let t=document.querySelector("style#inkey-wallet-styles");t&&document.head.removeChild(t)}},_=async t=>({frameBus:new v(t),username:void 0,account:void 0,async connect(e){e||(e={});let s={type:"connect",payload:e},r=await this.ping(s,{showFrame:!0});return this.account={addr:r.address,sk:new Uint8Array([])},this.username=r.username,[{address:r.address,username:r.username}]},async disconnect(){let e={type:"disconnect"};if(!this.account||!this.account.addr)throw new Error("no acct to disconnect");let s=await this.ping(e,{showFrame:!1});return s.success&&(this.account=void 0,this.username=void 0),s},show(e){this.frameBus&&this.frameBus.showFrame(e)},hide(){this.frameBus&&(this.frameBus.hideFrame(),this.ping({type:"reject"}))},async ping(e,s){if(!this.frameBus)throw new Error("No inkey frameBus");return this.frameBus.ready||await this.frameBus.isReady(),e.source="ncc-inkey-client",e.async=!0,s?.showFrame&&this.frameBus.showFrame(),await this.frameBus.emitAsync(e)},async signTxnsUint8Array(e){var s;let r={type:"sign-txns-raw",payload:{txns:e}},i=await this.ping(r,{showFrame:!0});return(s=this.frameBus)==null||s.hideFrame(),i.error?{success:!1,reject:!1,error:i.error}:i.reject?{success:!1,reject:!0}:{success:!0,reject:!1,signedTxns:i.signedTxns}},async signTxns(e){var s;let r;if(typeof e[0]=="string")r={type:"sign-txns",payload:{txns:e}};else if(typeof e[0]=="object")r={type:"sign-txns",payload:{txns:e}};else throw new Error("bad txns array input...");let i=await this.ping(r,{showFrame:!0});return(s=this.frameBus)==null||s.hideFrame(),i.error?{success:!1,reject:!1,error:i.error}:i.reject?{success:!1,reject:!0}:{success:!0,reject:!1,signedTxns:i.signedTxns}}});export{_ as createClient};
//# sourceMappingURL=index.esm-FBJLS5PI.mjs.map
